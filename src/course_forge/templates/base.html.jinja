<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_name }} - {{ course_name }}</title>
    <link rel="icon" href="/img/dark-favicon.svg" media="(prefers-color-scheme: light)">
    <link rel="icon" href="/img/light-favicon.svg" media="(prefers-color-scheme: dark)">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/katex.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="page-wrapper">
        <nav class="sidebar">
            <div class="sidebar-content">
                <header class="sidebar-title-section">
                    <a href="contents.html" class="course-title-link">
                        <h1 class="sidebar-course-title">{{ course_name }}</h1>
                    </a>
                    <div class="sidebar-ornament">❧</div>
                </header>

                {% if toc %}
                <section class="sidebar-toc-section">
                    <h2 class="toc-header">Tabela de Conteúdos</h2>
                    <ol class="toc-list">
                        {% for item in toc %}
                        <li class="toc-item level-{{ item.level }}">
                            <a href="#{{ item.id }}">{{ item.text }}</a>
                        </li>
                        {% endfor %}
                    </ol>
                </section>
                {% endif %}

                <nav class="sidebar-nav-section">
                    {% if prev_chapter %}
                    <a href="{{ prev_chapter.slug }}.html" class="sidebar-nav-link prev">← {{ prev_chapter.name }}</a>
                    {% endif %}
                    {% if next_chapter %}
                    <a href="{{ next_chapter.slug }}.html" class="sidebar-nav-link next">{{ next_chapter.name }} →</a>
                    {% endif %}
                    <a href="javascript:void(0)" onclick="handleBackNavigation()"
                        class="sidebar-nav-link back">Voltar</a>
                </nav>

            </div>
        </nav>

        <button class="mobile-menu-toggle" aria-label="Menu">
            <div class="hamburger-container">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </div>
        </button>

        <button class="sidebar-toggle" onclick="CourseForgeNav.toggleSidebar()" aria-label="Alternar Barra Lateral">
            <i data-lucide="chevron-left" class="toggle-icon"></i>
        </button>

        <div class="mobile-menu-overlay"></div>

        <main class="main-content">
            <article class="article">
                <header class="article-header">
                    <span class="chapter-number">{{ chapter_num }}</span>
                    <h1 class="article-title">
                        <span class="title-ornament left">❧</span>
                        <span class="title-text">{{ title }}</span>
                        <span class="title-ornament right">❧</span>
                    </h1>
                    {% if date %}
                    <p class="article-date">{{ date }}</p>
                    {% endif %}
                    {% if breadcrumbs %}
                    <nav class="breadcrumb" aria-label="Breadcrumb">
                        {% for crumb in breadcrumbs %}
                        {% if not loop.last %}
                        {% if crumb.url %}
                        <a href="{{ crumb.url }}" class="breadcrumb-link">{{ crumb.name }}</a>
                        {% else %}
                        <span class="breadcrumb-part">{{ crumb.name }}</span>
                        {% endif %}
                        <span class="breadcrumb-separator">›</span>
                        {% else %}
                        <span class="breadcrumb-current">{{ crumb.name }}</span>
                        {% endif %}
                        {% endfor %}
                    </nav>
                    {% endif %}
                </header>
                <div class="article-body">
                    {{ content }}
                </div>
            </article>
            <footer class="footer">
                <p>© 2025 · <a href="#">{{ author }}</a></p>
            </footer>
        </main>
    </div>

    <script>
        const toggle = document.querySelector('.mobile-menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.mobile-menu-overlay');

        function openMenu() {
            sidebar.classList.add('open');
            overlay.classList.add('open');
            toggle.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            toggle.classList.remove('open');
            document.body.style.overflow = '';
        }

        toggle.addEventListener('click', () => {
            if (sidebar.classList.contains('open')) {
                closeMenu();
            } else {
                openMenu();
            }
        });

        overlay.addEventListener('click', closeMenu);
    </script>

    <script src="/js/katex.min.js"></script>
    <script src="/js/auto-render.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true }
                ],
                throwOnError: false
            });
        });
    </script>
    <script src="/js/rough.min.js"></script>
    <script src="/js/apply_sketch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Restore mermaid content from base64 data-source if available
            // We use 'mermaid-hidden' to prevent premature rendering or auto-detection
            document.querySelectorAll('.mermaid-hidden').forEach(el => {
                if (el.dataset.source) {
                    try {
                        // decodeURIComponent(escape(atob(str))) handles UTF-8 characters correctly
                        const decoded = decodeURIComponent(escape(atob(el.dataset.source)));
                        el.textContent = decoded;
                        el.removeAttribute('data-source'); // Cleanup
                    } catch (e) {
                        console.error('Failed to decode mermaid source:', e);
                    }
                }
                // Now enable it for mermaid to find
                el.className = el.className.replace('mermaid-hidden', 'mermaid');
            });

            mermaid.run({
                querySelector: '.mermaid',
                postRenderCallback: (id) => {
                    // Apply sketch effect after mermaid renders
                    if (window.applySketchEffect) {
                        window.applySketchEffect();
                    }
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isSubcourse = {{ is_subcourse | tojson
        }};
        const courseName = {{ course_name | tojson }};
        CourseForgeNav.applyDynamicBreadcrumbs('.breadcrumb', isSubcourse);
        CourseForgeNav.initSidebar();
        CourseForgeNav.initScrollSpy();
        CourseForgeUI.initCopyButtons();
        });

        function handleBackNavigation() {
            const isSubcourse = {{ is_subcourse | tojson
        }};
        const dynamic = CourseForgeNav.getBackLink('contents.html', 'Voltar', isSubcourse);
        window.location.href = dynamic.url;
        }
    </script>
</body>

</html>